<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GateKeeper AI Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PrismJS (Syntax Highlighting) - Theme: Tomorrow Night -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .terminal { background: #000; border: 1px solid #333; font-family: 'Courier New', monospace; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }

        /* Code Block Styling */
        pre[class*="language-"] {
            border-radius: 0.75rem;
            margin: 1rem 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
<div id="root"></div>

<!-- PrismJS Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-diff.min.js"></script>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- COMPONENT: Code Highlighter ---
    const SmartReport = ({ content }) => {
        const codeRef = useRef(null);

        useEffect(() => {
            if (window.Prism) {
                window.Prism.highlightAllUnder(codeRef.current);
            }
        }, [content]);

        const parts = content.split(/(```[\s\S]*?```)/g);

        return (
            <div ref={codeRef} className="text-slate-300 space-y-4">
                {parts.map((part, index) => {
                    if (part.startsWith('```')) {
                        const match = part.match(/```(\w+)?\n([\s\S]*?)```/);
                        const lang = match && match[1] ? match[1] : 'java';
                        const code = match && match[2] ? match[2] : part.replace(/```/g, '');

                        return (
                            <div key={index} className="relative group">
                                <div className="absolute -top-3 right-4 bg-slate-700 text-xs px-2 py-1 rounded text-slate-300 opacity-50">
                                    {lang.toUpperCase()}
                                </div>
                                <pre className={`language-${lang} shadow-2xl`}>
                                    <code>{code}</code>
                                </pre>
                            </div>
                        );
                    } else {
                        return (
                            <div key={index} className="whitespace-pre-wrap leading-relaxed">
                                {part.split('\n').map((line, i) => {
                                    if (line.includes('Severity: HIGH')) {
                                        return <p key={i} className="text-red-400 font-bold mt-4 text-lg">{line.replace(/[*]/g, '')}</p>;
                                    }
                                    if (line.includes('Vulnerable Line:')) {
                                        return (
                                            <div key={i} className="mt-1 ml-4 p-2 bg-amber-900/30 border-l-4 border-amber-500 rounded-r text-amber-200 font-mono text-sm">
                                                {line.replace(/\*\*/g, '').replace('üî¥', '').trim()}
                                            </div>
                                        );
                                    }
                                    if (line.includes('Explanation:')) {
                                        return <p key={i} className="text-slate-400 text-sm mt-1 ml-4 italic">{line.replace(/\*\*/g, '').replace('üìù', '').trim()}</p>;
                                    }
                                    if (line.includes('SUGGESTED FIX')) {
                                        return <h3 key={i} className="text-blue-400 font-bold text-xl mt-8 mb-2 border-b border-slate-700 pb-2">{line.replace(/#/g,'')}</h3>;
                                    }
                                    if (line.includes('VULNERABILITY REPORT')) {
                                        return <h3 key={i} className="text-red-400 font-bold text-xl mt-4 mb-2 border-b border-slate-700 pb-2">{line.replace(/#/g,'')}</h3>;
                                    }
                                    return <span key={i}>{line}{'\n'}</span>;
                                })}
                            </div>
                        );
                    }
                })}
            </div>
        );
    };

    function App() {
        const [reports, setReports] = useState([]);
        const [logs, setLogs] = useState([]);
        // Track which report has its diff expanded
        const [expandedDiffs, setExpandedDiffs] = useState({});
        const logsEndRef = useRef(null);

        useEffect(() => {
            const eventSource = new EventSource('/api/stream');
            eventSource.onmessage = (event) => setLogs(prev => [...prev, event.data]);
            return () => eventSource.close();
        }, []);

        useEffect(() => {
            if (logsEndRef.current) logsEndRef.current.scrollIntoView({ behavior: "smooth" });
        }, [logs]);

        useEffect(() => {
            const fetchData = async () => {
                try {
                    const res = await fetch('/api/history');
                    const data = await res.json();
                    setReports(data);
                } catch (e) { console.error("Fetch error", e); }
            };
            fetchData();
            const interval = setInterval(fetchData, 2000);
            return () => clearInterval(interval);
        }, []);

        const toggleDiff = (id) => {
            setExpandedDiffs(prev => ({ ...prev, [id]: !prev[id] }));
            // Highlight syntax after render
            setTimeout(() => window.Prism && window.Prism.highlightAll(), 100);
        };

        return (
            <div className="min-h-screen p-8 max-w-6xl mx-auto">
                <header className="flex justify-between items-center mb-8">
                    <div className="flex items-center gap-3">
                        <div className="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/50">
                            <i data-lucide="shield-check" className="w-8 h-8 text-white"></i>
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">
                                GateKeeper AI
                            </h1>
                            <p className="text-slate-400 text-sm">Automated Compliance Agent</p>
                        </div>
                    </div>
                    <div className="text-right">
                        <p className="text-xs text-slate-500">POWERED BY</p>
                        <p className="font-bold text-white flex items-center justify-end gap-2">
                            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            IBM Watsonx
                        </p>
                    </div>
                </header>

                <div className="mb-8">
                    <div className="flex items-center gap-2 mb-2 text-slate-400 text-sm">
                        <i data-lucide="terminal" className="w-4 h-4"></i>
                        <span>Live Agent Activity</span>
                    </div>
                    <div className="terminal rounded-xl p-4 h-48 overflow-y-auto shadow-2xl text-sm text-green-400 border border-slate-800">
                        {logs.length === 0 && <span className="text-slate-600">Listening for GitHub Webhooks...</span>}
                        {logs.map((log, i) => (
                            <div key={i} className="mb-1 font-mono">
                                <span className="text-slate-600 mr-2">[{new Date().toLocaleTimeString()}]</span>
                                {log}
                            </div>
                        ))}
                        <div ref={logsEndRef} />
                    </div>
                </div>

                <div className="grid gap-8">
                    <h2 className="text-xl font-semibold text-white mb-2 flex items-center gap-2">
                        <i data-lucide="file-text" className="w-5 h-5"></i>
                        Recent Scans
                    </h2>

                    {reports.length === 0 ? (
                        <div className="text-center py-10 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl">
                            <p>No scans yet. Open a PR to trigger.</p>
                        </div>
                    ) : (
                        reports.map((report) => (
                            <div key={report.id} className="glass rounded-xl p-8 shadow-xl border-l-4 transition-all duration-500 animate-in fade-in slide-in-from-bottom-4"
                                 style={{ borderLeftColor: report.status === 'SAFE' ? '#10b981' : '#ef4444' }}>

                                <div className="flex justify-between items-start mb-6 border-b border-slate-700/50 pb-4">
                                    <div>
                                        <div className="flex items-center gap-3 mb-1">
                                            <h2 className="text-2xl font-bold text-white">{report.repository}</h2>
                                            <span className="bg-slate-700 text-xs px-2 py-1 rounded text-slate-300 font-mono">PR #{report.prNumber}</span>
                                        </div>
                                        <p className="text-xs text-slate-500 flex items-center gap-1">
                                            <i data-lucide="clock" className="w-3 h-3"></i>
                                            {new Date(report.timestamp).toLocaleString()}
                                        </p>
                                    </div>
                                    <span className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-lg ${report.status === 'SAFE' ? 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20' : 'bg-red-500/10 text-red-400 border border-red-500/20'}`}>
                                        {report.status === 'SAFE' ? <i data-lucide="check-circle" className="w-4 h-4"></i> : <i data-lucide="alert-triangle" className="w-4 h-4"></i>}
                                        {report.status === 'SAFE' ? 'PASSED' : 'VIOLATION DETECTED'}
                                    </span>
                                </div>

                                {/* --- NEW: Collapsible Diff Section --- */}
                                <div className="mb-6">
                                    <button
                                        onClick={() => toggleDiff(report.id)}
                                        className="text-slate-400 hover:text-white text-sm flex items-center gap-2 transition-colors focus:outline-none"
                                    >
                                        {expandedDiffs[report.id] ? <i data-lucide="chevron-down"></i> : <i data-lucide="chevron-right"></i>}
                                        <span className="font-mono">View Original Diff</span>
                                    </button>

                                    {expandedDiffs[report.id] && (
                                        <div className="mt-2 bg-slate-950 rounded-lg p-4 border border-slate-800 overflow-x-auto shadow-inner">
                                            <pre className="language-diff text-sm text-slate-300">
                                                <code>{report.rawDiff}</code>
                                            </pre>
                                        </div>
                                    )}
                                </div>

                                <SmartReport content={report.aiAnalysis} />

                            </div>
                        ))
                    )}
                </div>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    setTimeout(() => lucide.createIcons(), 100);
</script>
</body>
</html>